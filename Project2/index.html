<!doctype html>
<html>
<head>
  <title>EID Project 2</title>
  <meta charset="utf-8" />
  <style type="text/css">
    body {
      text-align: center;
      min-width: 500px;
    }
  </style>
  <script src="http://code.jquery.com/jquery.min.js"></script>
  <script>
   
      // log function
      log = function(data){
        console.log(data);
      };
      
      $(document).ready(function () {
        $("div#python_details").hide();
        $("#humidty_table_from_python_time").hide();
        $("#humidty_table_from_python").hide();
        $("div#nodejs_details").hide();
        $("#humidty_table_from_node").hide();
        
        var ws;
        
        // $("#open").click(function(evt) {
        //   evt.preventDefault();
        
        var host = $("#host").val();
        var port = $("#port").val();
        var uri = $("#uri").val();
        var temperaturePython;
        var humidityPython;
        var temperatureNode;
        var humidityNode;
        var sentMsg;
        
        var sentMsgNode;
        
        var pythonDbStartTime;
        var pythonDbEndTime;
        
        var nodeDbStartTime;
        var nodeDbEndTime;
        
        const ws_js = new WebSocket('ws://localhost:9898/');
        ws_js.onopen = function() {
          console.log('WebSocket Client Connected');
        };
        
        ws_js.onmessage = function(evt) {
          if(sentMsgNode == "getReadings")
          {
            $("div#nodejs_details").show();
            console.log(evt.data.trim())
            readings = JSON.parse(evt.data.toString().trim());
            console.log(readings.temp);
            console.log(readings.hum);
            temperatureNode = readings.temp;
            if(document.getElementById("fahren").checked)
            {
              document.getElementById("temperatureNode").value = (readings.temp * 9/5) + 32;  
            }
            else if(document.getElementById("celsius").checked)
            {
              document.getElementById("temperatureNode").value= readings.temp;
            }
            
            document.getElementById("humidityNode").value = readings.hum
          }
          
          else if(sentMsgNode = "getHumFromNodeDatabase")
          {
            humList = $.parseJSON(evt.data);
            console.log(humList);
            nodeDbEndTime = new Date();
            $("#humidty_table_from_node tbody tr:not(:first-child)").remove();
            $("#humidty_table_from_node_time tbody tr:not(:first-child)").remove();
              for(key in humList)
              {
                console.log(key);
                new_row = "<tr>";
                new_row += "<td>";
                new_row += key;
                new_row += "</td>";
                new_row += "<td>";
                new_row += humList[key].Humd;
                new_row += "</td>";
                new_row += "</tr>";
                $('#humidty_table_from_node tr:last').after(new_row);
              }
              
              $("#humidty_table_from_node").show();
              
              console.log("Start time = ");
              console.log(nodeDbStartTime);
              
              console.log("End time = ");
              console.log(nodeDbEndTime);
              
              console.log("Total time = ");
              console.log(nodeDbEndTime - nodeDbStartTime);
              
              new_row = "<tr>";
              new_row += "<td>";
              new_row += nodeDbStartTime;
              new_row += "</td>";
              new_row += "<td>";
              new_row += nodeDbEndTime;
              new_row += "</td>";
              new_row += "<td>";
              new_row += nodeDbEndTime - nodeDbStartTime;
              new_row += "</td>";
              new_row += "</tr>";
              $('#humidty_table_from_node_time tr:last').after(new_row);
              
              $('#humidty_table_from_node_time').show();
            }             

          };
          
          // create websocket instance
          ws = new WebSocket("ws://" + host + ":" + port + uri);
          
          // Handle incoming websocket message callback
          ws.onmessage = function(evt) {
            if(sentMsg == "getReadings")
            {
              console.log(evt.data)
              $("div#python_details").show();
              readings = $.parseJSON(evt.data);
              console.log(readings.Temperature);
              console.log(readings.Humidity);
              temperaturePython = readings.Temperature;
              if(document.getElementById("fahren").checked)
              {
                document.getElementById("temperaturePython").value = (readings.Temperature * 9/5) + 32;  
              }
              else if(document.getElementById("celsius").checked)
              {
                document.getElementById("temperaturePython").value= readings.Temperature;
              }
              
              document.getElementById("humidityPython").value = readings.Humidity
              
            }
            
            else if(sentMsg = "getHumFromPythonDatabase")
            {
              humList = $.parseJSON(evt.data);
              console.log(humList);
              pythonDbEndTime = new Date();
              $("#humidty_table_from_python tbody tr:not(:first-child)").remove();
              $("#humidty_table_from_python_time tbody tr:not(:first-child)").remove();
              for(key in humList)
              {
                console.log(key);
                new_row = "<tr>";
                new_row += "<td>";
                new_row += key;
                new_row += "</td>";
                new_row += "<td>";
                new_row += humList[key];
                new_row += "</td>";
                new_row += "</tr>";
                $('#humidty_table_from_python tr:last').after(new_row);
              }
              console.log("Start time = ");
              console.log(pythonDbStartTime);
              
              console.log("End time = ");
              console.log(pythonDbEndTime);
              
              console.log("Total time = ");
              console.log(pythonDbEndTime - pythonDbStartTime);
              
              new_row = "<tr>";
              new_row += "<td>";
              new_row += pythonDbStartTime;
              new_row += "</td>";
              new_row += "<td>";
              new_row += pythonDbEndTime;
              new_row += "</td>";
              new_row += "<td>";
              new_row += pythonDbEndTime - pythonDbStartTime;
              new_row += "</td>";
              new_row += "</tr>";
              $('#humidty_table_from_python_time tr:last').after(new_row);
              
              $('#humidty_table_from_python_time').show();
            }             
          };
          
          // Close Websocket callback
          ws.onclose = function(evt) {
            log("***Connection Closed***");
            alert("Connection close");
            $("div#python_details").empty();
            
          };
          
          // Open Websocket callback
          ws.onopen = function(evt) { 
            log("***Connection Opened***");
          };
        // });

        $("#button1").click(function(evt) {
          console.log("Button1");
          sentMsg = "getReadings";
          ws.send("Get Readings");
        });
        
        $("#button2").click(function(evt) {
          console.log("Button2");
          sentMsgNode = "getReadings";
          ws_js.send('getReadings');
        });

        $("#button3").click(function(evt) {
          console.log("Button3");
          pythonDbStartTime = new Date();
          sentMsg = "getHumFromPythonDatabase";
          ws.send("Humidity from database");
          $('#humidty_table_from_python').show();
        });
        
        $("#button4").click(function(evt) {
          console.log("Button4");
          nodeDbStartTime = new Date();
          sentMsgNode = "getHumFromNodeDatabase";
          ws_js.send('GetLast10HumVal');
        });
        
        // Send websocket message function
        $("#send").click(function(evt) {
          log("Sending Message: "+$("#message").val());
          ws.send($("#message").val());
        });
        
        $("#celsius").click(function(evt) {
          document.getElementById("temperaturePython").value = temperaturePython;
          document.getElementById("temperatureNode").value = temperatureNode;
        });
        
        $("#fahren").click(function(evt) {
          document.getElementById("temperaturePython").value = (temperaturePython * 9/5) + 32;
          document.getElementById("temperatureNode").value = (temperatureNode * 9/5) + 32;
        });
        
      });
    </script>
  </head>
  
  <body>
    <h1>Temperature Humidity Meter</h1>
    <button id="button1" value="button1">Get readings</button>
    <button id="button2" value="button2">Get node js</button>
    <button id="button3" value="button3">Get humidity from python database</button>
    <button id="button4" value="button4">Get humidity from node database</button>
    
    <div id="connection_details">
      <input type="text" id="host" value="localhost" style="display: none;"/><br />
      <input type="text" id="port" value="8888" style="display: none;"/><br />
      <input type="text" id="uri" value="/ws" style="display: none;"/><br />
    </div>
    <div id="python_deails">
    </br></br>
    <label for="temperaturePython">Temperature from python:</label>
    <input type="text" id="temperaturePython" value=""/><br />
    <label for="humidityPython">Humidity from python:</label>
    <input type="text" id="humidityPython" value=""/><br />
    
    <input type="radio" name="unit" id="celsius" value="celsius" checked> C
    <input type="radio" name="unit" id="fahren" value="fahren"> F <br />
  </div>
  
  <div id="nodejs_details">
    <label for="temperatureNode">Temperature from node js:</label>
    <input type="text" id="temperatureNode" value=""/><br />
    <label for="humidityNode">Humidity from node js:</label>
    <input type="text" id="humidityNode" value=""/><br />
  </div>
  
  <br />
  <table border="1" style="width:100%" id="humidty_table_from_python">
    <caption>Python MySQL</caption>
    <tr>
      <th>Entry number</th>
      <th>Humidity</th>
    </tr>
  </table>
  
  <br />
  <table border="1" style="width:100%" id="humidty_table_from_node">
    <caption>NodeJS MySQL</caption>
    <tr>
      <th>Entry number</th>
      <th>Humidity</th>
    </tr>
  </table>
  
  <br />
  <table border="1" style="width:100%" id="humidty_table_from_python_time">
    <caption>Time taken by python</caption>
    <tr>
      <th>Start time</th>
      <th>End time</th>
      <th>Transcation time[ms]</th>
    </tr>
  </table>

  <br />
  <table border="1" style="width:100%" id="humidty_table_from_node_time">
    <caption>Time taken by node js</caption>
    <tr>
      <th>Start time</th>
      <th>End time</th>
      <th>Transcation time[ms]</th>
    </tr>
  </table>

</body>
</html>
